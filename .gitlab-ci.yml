variables:
  GOPRIVATE: "gitlab.com/coreflux-cloud/*"

before_script:
  - git config --global url."git@gitlab.com:".insteadOf "https://gitlab.com/"
  - apt-get update -y && apt-get install -y openssh-client
  - eval $(ssh-agent -s)  # Start the ssh-agent
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -  # Add the SSH key
  - mkdir -p ~/.ssh
  - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
  - chmod -R 700 ~/.ssh
  - chmod 600 ~/.ssh/known_hosts
  - ssh -vT git@gitlab.com
  - go env

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - go.mod
    - go.sum
    - .cache/go-build
    - $GOPATH/pkg/mod
    - cache/

include:
    - template: Security/SAST.gitlab-ci.yml

stages:
    - lint
    - test
    - build

lint:
  stage: lint
  image: golang:1.21.9
  script:
    - go mod tidy
    - make fmt
    - make lint
  cache:
    policy: pull-push

test:     
  stage: test
  image: golang:1.21.9
  script:
    - go mod tidy
    - make test
  cache:
    policy: pull-push

sast:
  stage: test
  before_script: []
  script:
    - /analyzer run

build:
  stage: build
  image: golang:1.21.9
  script:
    - go mod tidy
    - make build
  cache:
    policy: pull-push

